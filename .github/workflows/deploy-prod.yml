name: Deploy to PROD

on:
  workflow_dispatch:

jobs:
  deploy-prod:
    # Ensure deployments run only from the main branch
    if: github.ref_name == 'main'
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Step 2: Install Salesforce CLI
      - name: Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli
          sf --version
      
      # Step 3: Authenticate to PROD using JWT
      - name: Authenticate to PROD
        run: |
          echo "Authenticating to PROD org using JWT Bearer Flow..."
          
          # Create a secure temporary file for the private key from GitHub secret
          KEY_FILE=$(mktemp)
          printf '%s' "${{ secrets.SF_PROD_JWT_KEY }}" > "$KEY_FILE"
          
          # Authenticate using JWT
          sf org login jwt --client-id "${{ secrets.SF_PROD_CLIENT_ID }}" --jwt-key-file "$KEY_FILE" --username "${{ secrets.SF_PROD_USERNAME }}" --instance-url "https://${{ secrets.SF_PROD_INSTANCE_URL }}" --set-default --alias prod
          
          # Remove the private key file for security
          rm -f "$KEY_FILE"
          
          echo "âœ… Authentication to PROD successful"
      
      # Step 4: Configure test execution (always run tests in PROD)
      - name: Configure test execution
        run: |
          echo "Configuring test execution for PROD..."
          
          # For PROD, always run Apex tests (no NoTestRun allowed)
          TEST_LEVEL=RunLocalTests
          TEST_CLASSES=""
          
          echo "Using test level: $TEST_LEVEL"
          echo "TEST_LEVEL=$TEST_LEVEL" >> $GITHUB_ENV
          echo "TEST_CLASSES=$TEST_CLASSES" >> $GITHUB_ENV
      
      # Step 5: Deploy all metadata to PROD
      - name: Deploy to PROD
        id: deploy
        run: |
          echo "ðŸš€ Deploying all metadata from force-app to PROD..."
          echo "Test level: $TEST_LEVEL"
          
          # Build the deployment command
          DEPLOY_CMD="sf project deploy start --source-dir force-app"
          
          # Add test level (always run tests in PROD)
          if [ "$TEST_LEVEL" = "RunSpecifiedTests" ] && [ -n "$TEST_CLASSES" ]; then
            echo "Running specified tests: $TEST_CLASSES"
            TEST_FLAGS=""
            for test_class in $TEST_CLASSES; do
              TEST_FLAGS="$TEST_FLAGS --tests $test_class"
            done
            DEPLOY_CMD="$DEPLOY_CMD --test-level RunSpecifiedTests $TEST_FLAGS"
          else
            echo "Running local tests (RunLocalTests)"
            DEPLOY_CMD="$DEPLOY_CMD --test-level RunLocalTests"
          fi
          
          # Add JSON output for parsing
          DEPLOY_CMD="$DEPLOY_CMD --json"
          
          echo "Executing: $DEPLOY_CMD"
          
          # Execute deployment and capture output
          set +e
          DEPLOY_RESULT=$(eval $DEPLOY_CMD 2>&1)
          DEPLOY_STATUS=$?
          set -e
          
          echo "=== Deployment Output ==="
          echo "$DEPLOY_RESULT"
          echo "========================="
          
          # Save results to file
          echo "$DEPLOY_RESULT" > deploy-results.json
          
          # Check deployment status
          if [ $DEPLOY_STATUS -ne 0 ]; then
            echo "âŒ Deployment to PROD failed with exit code $DEPLOY_STATUS"
            echo "Full error output:"
            cat deploy-results.json
            echo "deployment_status=failed" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "âœ… Deployment to PROD successful"
            echo "deployment_status=success" >> $GITHUB_OUTPUT
          fi
      
      # Step 6: Upload deployment results as artifacts
      - name: Upload deployment results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: prod-deployment-results
          path: deploy-results.json
          retention-days: 30
      
      # Step 7: Add deployment summary
      - name: Add deployment summary
        if: always()
        run: |
          echo "## ðŸš€ PROD Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** Manual workflow dispatch" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Deployment Scope" >> $GITHUB_STEP_SUMMARY
          echo "Deployed all metadata from \`force-app/\` directory" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Test Configuration" >> $GITHUB_STEP_SUMMARY
          echo "**Test Level:** $TEST_LEVEL" >> $GITHUB_STEP_SUMMARY
          if [ "$TEST_LEVEL" = "RunSpecifiedTests" ] && [ -n "$TEST_CLASSES" ]; then
            echo "**Test Classes:**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$TEST_CLASSES" | tr ' ' '\n' >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Test Classes:** All local tests (RunLocalTests)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.deploy.outputs.deployment_status }}" = "success" ]; then
            echo "### âœ… Deployment Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Deployment Status: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
