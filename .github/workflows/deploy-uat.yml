name: Deploy to UAT

on:
  push:
    branches:
      - "uat"

jobs:
  deploy-uat:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # Step 2: Install Salesforce CLI
      - name: Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli
          sf --version
      
      # Step 3: Authenticate to UAT Sandbox
      - name: Authenticate to UAT
        run: |
          echo "Authenticating to UAT sandbox..."
          sf org login sfdx-url --sfdx-url-stdin <<< "force://${{ secrets.SF_USERNAME }}:${{ secrets.SF_PASSWORD }}${{ secrets.SF_SECURITY_TOKEN }}@test.salesforce.com"
          echo "Authentication successful"
        env:
          SF_USERNAME: ${{ secrets.SF_USERNAME }}
          SF_PASSWORD: ${{ secrets.SF_PASSWORD }}
          SF_SECURITY_TOKEN: ${{ secrets.SF_SECURITY_TOKEN }}
      
      # Step 4: Detect changed metadata files
      - name: Detect changed metadata files
        id: detect-changes
        run: |
          echo "Detecting changed metadata files..."
          
          # Get the list of changed files in the last merge
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | grep '^force-app/' || true)
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No metadata files changed in force-app directory"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Convert newline-separated list to comma-separated
          CHANGED_FILES_CSV=$(echo "$CHANGED_FILES" | tr '\n' ',' | sed 's/,$//')
          
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "changed_files=$CHANGED_FILES_CSV" >> $GITHUB_OUTPUT
          echo "CHANGED_FILES=$CHANGED_FILES_CSV" >> $GITHUB_ENV
      
      # Step 5: Detect changed Apex classes and derive test class names
      - name: Detect Apex test classes
        id: detect-tests
        if: steps.detect-changes.outputs.has_changes == 'true'
        run: |
          echo "Detecting changed Apex classes..."
          
          # Extract Apex class files from changed files
          APEX_CLASSES=$(echo "$CHANGED_FILES" | tr ',' '\n' | grep '\.cls$' | grep -v 'meta.xml' || true)
          
          if [ -z "$APEX_CLASSES" ]; then
            echo "No Apex classes changed"
            echo "has_tests=false" >> $GITHUB_OUTPUT
            echo "TEST_LEVEL=NoTestRun" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "Changed Apex classes:"
          echo "$APEX_CLASSES"
          
          # Extract class names and append _Test
          TEST_CLASSES=""
          for class_file in $APEX_CLASSES; do
            # Extract just the class name without path and extension
            class_name=$(basename "$class_file" .cls)
            test_class_name="${class_name}_Test"
            
            if [ -z "$TEST_CLASSES" ]; then
              TEST_CLASSES="$test_class_name"
            else
              TEST_CLASSES="$TEST_CLASSES,$test_class_name"
            fi
          done
          
          echo "Test classes to run: $TEST_CLASSES"
          echo "has_tests=true" >> $GITHUB_OUTPUT
          echo "test_classes=$TEST_CLASSES" >> $GITHUB_OUTPUT
          echo "TEST_CLASSES=$TEST_CLASSES" >> $GITHUB_ENV
          echo "TEST_LEVEL=RunSpecifiedTests" >> $GITHUB_ENV
        env:
          CHANGED_FILES: ${{ steps.detect-changes.outputs.changed_files }}
      
      # Step 6: Exit if no changes detected
      - name: Exit if no changes
        if: steps.detect-changes.outputs.has_changes == 'false'
        run: |
          echo "âœ… No metadata changes detected. Workflow completed successfully."
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "No metadata files were changed in this merge." >> $GITHUB_STEP_SUMMARY
          echo "Deployment skipped." >> $GITHUB_STEP_SUMMARY
      
      # Step 7: Deploy changed metadata with appropriate test level
      - name: Deploy to UAT
        if: steps.detect-changes.outputs.has_changes == 'true'
        id: deploy
        run: |
          echo "Deploying changed metadata to UAT..."
          echo "Changed files: $CHANGED_FILES"
          echo "Test level: $TEST_LEVEL"
          
          # Build the deployment command
          DEPLOY_CMD="sf project deploy start --source-dir $(echo $CHANGED_FILES | tr ',' ' ')"
          
          # Add test level
          if [ "$TEST_LEVEL" = "RunSpecifiedTests" ]; then
            echo "Running specified tests: $TEST_CLASSES"
            DEPLOY_CMD="$DEPLOY_CMD --test-level RunSpecifiedTests --tests $TEST_CLASSES"
          else
            echo "No tests will be run (NoTestRun)"
            DEPLOY_CMD="$DEPLOY_CMD --test-level NoTestRun"
          fi
          
          # Add JSON output for parsing
          DEPLOY_CMD="$DEPLOY_CMD --json"
          
          echo "Executing: $DEPLOY_CMD"
          
          # Execute deployment
          DEPLOY_RESULT=$(eval $DEPLOY_CMD)
          DEPLOY_STATUS=$?
          
          echo "$DEPLOY_RESULT"
          
          # Save results to file
          echo "$DEPLOY_RESULT" > deploy-results.json
          
          # Check deployment status
          if [ $DEPLOY_STATUS -ne 0 ]; then
            echo "âŒ Deployment failed"
            echo "deployment_status=failed" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "âœ… Deployment successful"
            echo "deployment_status=success" >> $GITHUB_OUTPUT
          fi
      
      # Step 8: Upload test results as artifacts
      - name: Upload test results
        if: steps.detect-changes.outputs.has_changes == 'true' && always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-results
          path: deploy-results.json
          retention-days: 30
      
      # Step 9: Add deployment summary
      - name: Add deployment summary
        if: steps.detect-changes.outputs.has_changes == 'true' && always()
        run: |
          echo "## ðŸš€ UAT Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** uat" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Changed Files" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "$CHANGED_FILES" | tr ',' '\n' >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$TEST_LEVEL" = "RunSpecifiedTests" ]; then
            echo "### Test Classes Executed" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$TEST_CLASSES" | tr ',' '\n' >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Tests" >> $GITHUB_STEP_SUMMARY
            echo "No Apex tests were executed (no Apex classes modified)." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.deploy.outputs.deployment_status }}" = "success" ]; then
            echo "### âœ… Deployment Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Deployment Status: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
